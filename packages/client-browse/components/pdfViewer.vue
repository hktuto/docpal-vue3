<template>
    <div class="contentContainer" v-loading="loading">
        <iframe ref="iframe" :src="pdfReaderUrl" allowfullscreen />
    </div>
</template>

<script lang="ts" setup>
import { GetDocumentPreview, GetAnnotation } from 'dp-api'
import {useI18n} from 'vue-i18n';
import { useEventListener } from '@vueuse/core'


const demoAnnotation = [
    {
        "id": "pdfjs_internal_editor_3",
        "annotationType": 15,
        "color": [
            0,
            0,
            0
        ],
        "thickness": 1,
        "opacity": 1,
        "paths": [
            {
                "bezier": [
                    0.5,
                    85.65836842105261,
                    7.114349189434274,
                    85.65836842105261,
                    15.383199161209268,
                    53.24649817124163,
                    20.509791529605263,
                    46.71882456825656,
                    34.60885683789514,
                    28.766529978374564,
                    56.95212386075915,
                    20.154846910236984,
                    79.11033238075659,
                    27.54736375411182,
                    147.9412353045912,
                    50.51102567580315,
                    48.69003237715158,
                    86.5130960363416,
                    41.70058910361843,
                    49.46022719983551,
                    33.99514232390698,
                    8.611636306128474,
                    135.03981830111476,
                    33.421867341721644,
                    127.95074555921053,
                    54.68908556743419,
                    124.23762314921717,
                    65.82845279741423,
                    108.47672842731735,
                    45.61691365307189,
                    107.21888815789474,
                    42.260985690789454,
                    103.29457687153871,
                    31.79089159479718,
                    102.66217954579088,
                    18.996743113581232,
                    109.41568178453949,
                    9.492657360197342,
                    121.96275744876117,
                    -8.164623092419475,
                    155.38683455925664,
                    7.3671938335256755,
                    164.7761050164474,
                    20.571473129111823
                ],
                "points": [
                    0.5,
                    85.65836842105261,
                    16.150623302451574,
                    55.55699059651527,
                    11.062804572691986,
                    68.63647409577399,
                    20.509791529605263,
                    46.71882456825656,
                    62.58868471236855,
                    24.899645036110083,
                    46.78788325079059,
                    27.628789873525378,
                    79.11033238075659,
                    27.54736375411182,
                    60.17387859535731,
                    64.89728628458002,
                    88.8380905662004,
                    61.00999451129769,
                    41.70058910361843,
                    49.46022719983551,
                    116.3812827226182,
                    39.15563566409687,
                    84.59452706723678,
                    28.78122796385251,
                    127.95074555921053,
                    54.68908556743419,
                    110.46673440160768,
                    47.18513192231903,
                    116.66408605583861,
                    53.91077132621025,
                    107.21888815789474,
                    42.260985690789454,
                    105.67144274876036,
                    17.149887856812274,
                    104.31310489930287,
                    25.514568397015257,
                    109.41568178453949,
                    9.492657360197342,
                    153.9293729276156,
                    10.78679777374429,
                    138.28007035313004,
                    3.4589803390784706,
                    164.7761050164474,
                    20.571473129111823
                ]
            }
        ],
        "pageIndex": 0,
        "rect": [
            0,
            755.7316315789474,
            166.05067368421052,
            841.89
        ],
        "rotation": 0
    },
    {
        "id": "pdfjs_internal_editor_1",
        "annotationType": 15,
        "color": [
            0,
            0,
            0
        ],
        "thickness": 1,
        "opacity": 1,
        "paths": [
            {
                "bezier": [
                    4.101205722619516,
                    116.82985141292966,
                    -17.05610388457528,
                    82.49576290729834,
                    62.78340560095657,
                    103.52478737627558,
                    42.6399418245932,
                    127.89948837839017,
                    23.19468765976119,
                    151.42931728170277,
                    -15.541485405022826,
                    90.86879891530955,
                    18.111119394494516,
                    114.65447499434413,
                    21.312552258339498,
                    116.91724917012758,
                    23.704081553550086,
                    118.94376782497493,
                    25.836612301566884,
                    122.1688554219757,
                    28.88432183379495,
                    126.77799422140009,
                    25.836612301566884,
                    111.11757606342307,
                    25.836612301566884,
                    105.59193638414676,
                    25.836612301566884,
                    99.6582177932826,
                    28.548423875483362,
                    85.39126210818449,
                    25.836612301566884,
                    80.0595647764165,
                    22.936413591182443,
                    74.35747917633856,
                    3.4301614946899375,
                    86.14260481303266,
                    6.652913082816886,
                    80.61641218595597,
                    10.49314915412267,
                    74.03139199958224,
                    46.36144436047914,
                    73.5701507344757,
                    45.41805966998794,
                    73.5701507344757
                ],
                "points": [
                    4.101205722619516,
                    116.82985141292966,
                    42.14104142580134,
                    111.05854942116548,
                    22.990381587044574,
                    100.3488738302552,
                    42.6399418245932,
                    127.89948837839017,
                    5.012066382471556,
                    109.99830842928694,
                    10.463833497912852,
                    121.1810389954714,
                    18.111119394494516,
                    114.65447499434413,
                    25.836612301566884,
                    122.1688554219757,
                    26.265196454536454,
                    111.16136936717128,
                    26.979503376152408,
                    117.680937832574,
                    25.836612301566884,
                    105.59193638414676,
                    26.980657809312895,
                    85.46387847512369,
                    26.85354164178556,
                    92.59999260812057,
                    25.836612301566884,
                    80.0595647764165,
                    7.882927315857705,
                    82.05891150525244,
                    13.948656330250115,
                    80.27202861631076,
                    6.652913082816886,
                    80.61641218595597,
                    40.29902912957081,
                    73.74511062256069,
                    27.829344162076282,
                    74.62389889032569,
                    45.41805966998794,
                    73.5701507344757
                ]
            },
            {
                "bezier": [
                    11.08321554992215,
                    29.12026520815992,
                    20.811997156524964,
                    29.12026520815992,
                    30.53897538332879,
                    29.60674179121912,
                    40.29322774153399,
                    29.60674179121912,
                    48.961743709177036,
                    29.60674179121912,
                    6.505386321588312,
                    22.87561925832439,
                    15.173902289231359,
                    22.87561925832439,
                    55.555571229901815,
                    22.87561925832439,
                    16.04881665456343,
                    23.24018608513265,
                    18.9219136995932,
                    19.984296170330964,
                    26.448643431354963,
                    11.454753644966246,
                    55.412963485156105,
                    24.806445027602877,
                    38.33202340354057,
                    32.74895217362044,
                    12.69659132979381,
                    44.66923299330024,
                    -22.94814578073249,
                    9.32135578512073,
                    24.646427453705044,
                    1.4186363841467653
                ],
                "points": [
                    11.08321554992215,
                    29.12026520815992,
                    40.29322774153399,
                    29.60674179121912,
                    16.660776775254035,
                    23.927357154089194,
                    27.733565015382673,
                    26.241180524771757,
                    15.173902289231359,
                    22.87561925832439,
                    22.802871295634013,
                    21.809643960636897,
                    31.113622455277536,
                    22.65091643237831,
                    18.9219136995932,
                    19.984296170330964,
                    43.56366172775934,
                    26.20426255325088,
                    37.85484473158337,
                    20.189605545207346,
                    38.33202340354057,
                    32.74895217362044,
                    3.1008586022178726,
                    11.324247463805392,
                    4.027973438053698,
                    24.51741936162876,
                    24.646427453705044,
                    1.4186363841467653
                ]
            }
        ],
        "pageIndex": 1,
        "rect": [
            0,
            707.9529,
            46.99547368421053,
            841.89
        ],
        "rotation": 0
    },
    {
        "id": "pdfjs_internal_editor_0",
        "annotationType": 15,
        "color": [
            0,
            0,
            0
        ],
        "thickness": 1,
        "opacity": 1,
        "paths": [
            {
                "bezier": [
                    58.618360903793054,
                    97.40723684210525,
                    41.07720002428528,
                    85.68561404262238,
                    -13.8461630703336,
                    32.42176464948385,
                    4.032016763168054,
                    8.574777014802606,
                    20.493537335496967,
                    -13.38258560221118,
                    87.58002491148434,
                    21.936824853511453,
                    91.1786363560957,
                    43.95294512746709
                ],
                "points": [
                    58.618360903793054,
                    97.40723684210525,
                    2.55205016920142,
                    30.866943565022513,
                    18.04293606610202,
                    57.53801874165332,
                    4.032016763168054,
                    8.574777014802606,
                    78.35871417198909,
                    26.04930150127066,
                    52.42891748252596,
                    9.773804987021315,
                    91.1786363560957,
                    43.95294512746709
                ]
            }
        ],
        "pageIndex": 2,
        "rect": [
            0,
            743.9827631578947,
            92.42443157894736,
            841.89
        ],
        "rotation": 0
    },
    {
        "id": "pdfjs_internal_editor_6",
        "annotationType": 15,
        "color": [
            0,
            0,
            0
        ],
        "thickness": 1,
        "opacity": 1,
        "paths": [
            {
                "bezier": [
                    12.390868714484387,
                    63.90551828298089,
                    12.390868714484387,
                    45.89343733842897,
                    105.84511844818265,
                    91.28489364157575,
                    70.26934369392518,
                    108.97038364071116,
                    45.71903156179163,
                    121.17487680179235,
                    10.802383686139352,
                    66.23470287844147,
                    29.30740348010939,
                    48.968545462257204,
                    65.48584382761378,
                    15.21215648959624,
                    83.23641091449494,
                    92.18360339487685,
                    51.48645222599755,
                    74.64471832409932,
                    35.88785991210799,
                    66.02795379399812,
                    41.94457479719497,
                    33.89733138942006,
                    49.09690372681992,
                    22.54582991949404,
                    51.15799663839055,
                    19.27465776765969,
                    84.15187908628367,
                    -9.102951195837235,
                    87.90794433126071,
                    5.427361477882201,
                    93.49849404121393,
                    27.054364739399915,
                    -1.4907543487652573,
                    40.90365568626535,
                    0.5318546519843875,
                    1.9791909803493013
                ],
                "points": [
                    12.390868714484387,
                    63.90551828298089,
                    76.23436195283992,
                    91.93498345235295,
                    54.67102173705133,
                    73.05136185796327,
                    70.26934369392518,
                    108.97038364071116,
                    24.448513769355717,
                    67.34424968837041,
                    33.64262411472844,
                    90.02095851795873,
                    29.30740348010939,
                    48.968545462257204,
                    66.50308285503016,
                    73.28504125439031,
                    65.87007749155413,
                    55.72506792997197,
                    51.48645222599755,
                    74.64471832409932,
                    44.259329868490184,
                    34.26346340329317,
                    41.7600825100908,
                    49.62080047423099,
                    49.09690372681992,
                    22.54582991949404,
                    80.54897040228178,
                    1.512137928806958,
                    67.86680940401291,
                    7.3110388891054505,
                    87.90794433126071,
                    5.427361477882201,
                    14.11725154514223,
                    21.98052350204808,
                    45.55787725757389,
                    26.41007671690341,
                    0.5318546519843875,
                    1.9791909803493013
                ]
            }
        ],
        "pageIndex": 2,
        "rect": [
            0,
            730.6673789473684,
            89.2914,
            841.89
        ],
        "rotation": 0
    },
    {
        "id": "pdfjs_internal_editor_2",
        "annotationType": 15,
        "color": [
            0,
            0,
            0
        ],
        "thickness": 1,
        "opacity": 1,
        "paths": [
            {
                "bezier": [
                    4.241892208059211,
                    65.15451009365299,
                    17.645703539030098,
                    65.15451009365299,
                    30.826367047362886,
                    59.86720971050215,
                    45.50979253700658,
                    62.46206108049509,
                    55.09109528324505,
                    64.15526656411535,
                    93.5277136646392,
                    74.83797880089568,
                    74.81465236430921,
                    90.88269617506747,
                    54.28032700476632,
                    108.48897884445334,
                    23.785704941726234,
                    75.14934257437217,
                    36.75627364309211,
                    54.19501876963982,
                    68.78609216492411,
                    2.449933094051545,
                    85.888885996721,
                    90.83827850183896,
                    53.36990789473685,
                    65.13309288559377,
                    26.446172631145803,
                    43.85076321758296,
                    68.9375620468102,
                    0.5315319643984253,
                    69.21252265625,
                    1.196607626547717,
                    76.39048446858585,
                    18.558686198266003,
                    11.240582510237648,
                    28.78503120796219,
                    0.5,
                    28.78503120796219
                ],
                "points": [
                    4.241892208059211,
                    65.15451009365299,
                    34.75202395058291,
                    61.78805331708524,
                    24.395987063030596,
                    62.83521632332669,
                    45.50979253700658,
                    62.46206108049509,
                    79.47771145105966,
                    79.91121382044591,
                    70.77260896812106,
                    71.29056166882447,
                    74.81465236430921,
                    90.88269617506747,
                    34.34329714370783,
                    71.24345721974174,
                    43.22112773085988,
                    86.99908490014798,
                    36.75627364309211,
                    54.19501876963982,
                    68.99716465932455,
                    66.99174131369979,
                    69.26888950284554,
                    49.89909330536314,
                    53.36990789473685,
                    65.13309288559377,
                    62.83496482121366,
                    7.913277043740409,
                    51.09170432310685,
                    24.934573257260706,
                    69.21252265625,
                    1.196607626547717,
                    16.7769157914053,
                    26.915882322514065,
                    41.57571544909006,
                    21.50159888164931,
                    0.5,
                    28.78503120796219
                ]
            }
        ],
        "pageIndex": 3,
        "rect": [
            0,
            745.5492789473684,
            81.45882105263159,
            841.89
        ],
        "rotation": 0
    }
]

const props = defineProps<{
    doc: any
}>()

const iframe = ref<HTMLIFrameElement>();
const {public:{pdfReaderUrl}} = useRuntimeConfig();
const loading = ref(false);
// const colorMode = useColorMode();
const {locale} = useI18n()

async function getAnnotation():Promise<Object> {
    const annotation = await GetAnnotation(props.doc.id )
    let annotationObj = []
    if(annotation.length > 0) {
        if(annotation[0].object.paths) {
            annotationObj = JSON.parse(annotation[0].object.paths)
        }
    }
    return annotationObj;
}

async function sendPdfAndAnnotation() {
    console.log('sendPdfAndAnnotation');
    loading.value = true;
    try {
        const blob = await GetDocumentPreview(props.doc.id);
        const annotations = await getAnnotation()
        const frame = iframe.value?.contentWindow;
        frame?.postMessage({blob, filename: props.doc.name, annotations:demoAnnotation, locale: locale.value, }, '*');
    } catch (error) {
        console.log(error);
    }
    loading.value = false;
}

function gotMessageFromIframe(message:MessageEvent) {
    console.log(message);
    const { data } = message;
    if(!data) return;

    if(data.type === 'ready' ) {
        sendPdfAndAnnotation()
    }
}

useEventListener(window, 'message', gotMessageFromIframe)

</script>

<style lang="scss" scoped>
.contentContainer{
     width: 100%;
    max-width: 800px;
    height: 100%;
    margin: 0 auto;
    background: #fff;
    border-radius: 12px;
    overflow: hidden;
}
iframe {
        width: 100%;
        height: 100%;
        border: none;
    }
</style>
